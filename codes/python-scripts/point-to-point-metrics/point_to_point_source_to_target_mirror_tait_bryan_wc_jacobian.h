inline void transform_point_mirror_tait_bryan_wc(double &x, double &y, double &z, double tx, double ty, double tz, double om, double fi, double ka, double ray_dir_x, double ray_dir_y, double ray_dir_z, double ray_length, double plane_a, double plane_b, double plane_c, double plane_d)
{x = tx + (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*cos(fi)*cos(ka) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*sin(ka)*cos(fi) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*sin(fi);
y = ty + (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(sin(fi)*sin(om)*cos(ka) + sin(ka)*cos(om)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(-sin(fi)*sin(ka)*sin(om) + cos(ka)*cos(om)) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*sin(om)*cos(fi);
z = tz + (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(-sin(fi)*cos(ka)*cos(om) + sin(ka)*sin(om)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(sin(fi)*sin(ka)*cos(om) + sin(om)*cos(ka)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*cos(fi)*cos(om);
}
inline void point_to_point_source_to_target_mirror_tait_bryan_wc_jacobian(Eigen::Matrix<double, 3, 10, Eigen::RowMajor> &j, double tx, double ty, double tz, double om, double fi, double ka, double ray_dir_x, double ray_dir_y, double ray_dir_z, double ray_length, double plane_a, double plane_b, double plane_c, double plane_d, double x_t, double y_t, double z_t)
{j.coeffRef(0,0) = -1;
j.coeffRef(0,1) = 0;
j.coeffRef(0,2) = 0;
j.coeffRef(0,3) = 0;
j.coeffRef(0,4) = -(-plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*sin(fi)*cos(ka) + (-plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*cos(fi) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*sin(fi)*sin(ka);
j.coeffRef(0,5) = -(-plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*sin(ka)*cos(fi) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*cos(fi)*cos(ka);
j.coeffRef(0,6) = (2*plane_b*ray_dir_x*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(ka)*cos(fi) + (-2*plane_c*ray_dir_x*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(fi) + (plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(4*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(ka);
j.coeffRef(0,7) = (-2*plane_a*ray_dir_y*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(ka) + (-2*plane_c*ray_dir_y*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(fi) + (-plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(2*plane_a*ray_dir_x + 4*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(ka)*cos(fi);
j.coeffRef(0,8) = (-2*plane_a*ray_dir_z*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + plane_d*ray_dir_x*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(ka) + (2*plane_b*ray_dir_z*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_y*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(ka)*cos(fi) + (plane_d*ray_dir_y*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 4*plane_c*ray_dir_z) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(fi);
j.coeffRef(0,9) = (-ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(ka) + (-ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(fi) + (ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(ka)*cos(fi);
j.coeffRef(1,0) = 0;
j.coeffRef(1,1) = -1;
j.coeffRef(1,2) = 0;
j.coeffRef(1,3) = (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(-sin(fi)*cos(ka)*cos(om) + sin(ka)*sin(om)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(sin(fi)*sin(ka)*cos(om) + sin(om)*cos(ka)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*cos(fi)*cos(om);
j.coeffRef(1,4) = -(plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*sin(om)*cos(fi)*cos(ka) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*sin(ka)*sin(om)*cos(fi) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*sin(fi)*sin(om);
j.coeffRef(1,5) = (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(sin(fi)*sin(ka)*sin(om) - cos(ka)*cos(om)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(sin(fi)*sin(om)*cos(ka) + sin(ka)*cos(om));
j.coeffRef(1,6) = (sin(fi)*sin(ka)*sin(om) - cos(ka)*cos(om))*(2*plane_b*ray_dir_x*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (-sin(fi)*sin(om)*cos(ka) - sin(ka)*cos(om))*(-plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(4*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (2*plane_c*ray_dir_x*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(om)*cos(fi);
j.coeffRef(1,7) = (sin(fi)*sin(ka)*sin(om) - cos(ka)*cos(om))*(-plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(2*plane_a*ray_dir_x + 4*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (-sin(fi)*sin(om)*cos(ka) - sin(ka)*cos(om))*(2*plane_a*ray_dir_y*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (2*plane_c*ray_dir_y*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(om)*cos(fi);
j.coeffRef(1,8) = (sin(fi)*sin(ka)*sin(om) - cos(ka)*cos(om))*(2*plane_b*ray_dir_z*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_y*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (-sin(fi)*sin(om)*cos(ka) - sin(ka)*cos(om))*(2*plane_a*ray_dir_z*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (-plane_d*ray_dir_y*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 4*plane_c*ray_dir_z) + (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(om)*cos(fi);
j.coeffRef(1,9) = (ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(-sin(fi)*sin(om)*cos(ka) - sin(ka)*cos(om)) + (ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(sin(fi)*sin(ka)*sin(om) - cos(ka)*cos(om)) + (ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*sin(om)*cos(fi);
j.coeffRef(2,0) = 0;
j.coeffRef(2,1) = 0;
j.coeffRef(2,2) = -1;
j.coeffRef(2,3) = (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(-sin(fi)*sin(om)*cos(ka) - sin(ka)*cos(om)) - (-plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*sin(om)*cos(fi) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(sin(fi)*sin(ka)*sin(om) - cos(ka)*cos(om));
j.coeffRef(2,4) = (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*cos(fi)*cos(ka)*cos(om) - (-plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*sin(fi)*cos(om) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*sin(ka)*cos(fi)*cos(om);
j.coeffRef(2,5) = (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(-sin(fi)*sin(ka)*cos(om) - sin(om)*cos(ka)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(-sin(fi)*cos(ka)*cos(om) + sin(ka)*sin(om));
j.coeffRef(2,6) = (-sin(fi)*sin(ka)*cos(om) - sin(om)*cos(ka))*(2*plane_b*ray_dir_x*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (sin(fi)*cos(ka)*cos(om) - sin(ka)*sin(om))*(-plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(4*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (-2*plane_c*ray_dir_x*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_x*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(om);
j.coeffRef(2,7) = (-sin(fi)*sin(ka)*cos(om) - sin(om)*cos(ka))*(-plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(2*plane_a*ray_dir_x + 4*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (sin(fi)*cos(ka)*cos(om) - sin(ka)*sin(om))*(2*plane_a*ray_dir_y*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (-2*plane_c*ray_dir_y*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_y/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*ray_dir_y*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(om);
j.coeffRef(2,8) = (-sin(fi)*sin(ka)*cos(om) - sin(om)*cos(ka))*(2*plane_b*ray_dir_z*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_y*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (sin(fi)*cos(ka)*cos(om) - sin(ka)*sin(om))*(2*plane_a*ray_dir_z*(-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) - plane_d*ray_dir_x*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))) + (plane_d*ray_dir_y*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) - (-ray_length + sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 4*plane_c*ray_dir_z) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(-pow(plane_d, 2)*pow(ray_dir_x, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_y, 2)*ray_dir_z/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3) - pow(plane_d, 2)*pow(ray_dir_z, 3)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 3))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(om);
j.coeffRef(2,9) = (ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(sin(fi)*cos(ka)*cos(om) - sin(ka)*sin(om)) + (-ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*cos(fi)*cos(om) + (ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) + (plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y)*(plane_d*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + plane_d*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2))/sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(-sin(fi)*sin(ka)*cos(om) - sin(om)*cos(ka));
}
inline void point_to_point_source_to_target_mirror_tait_bryan_wc(Eigen::Matrix<double, 3, 1> delta, double tx, double ty, double tz, double om, double fi, double ka, double ray_dir_x, double ray_dir_y, double ray_dir_z, double ray_length, double plane_a, double plane_b, double plane_c, double plane_d, double x_t, double y_t, double z_t)
{delta.coeffRef(0,0) = -tx + x_t - (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*cos(fi)*cos(ka) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*sin(ka)*cos(fi) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*sin(fi);
delta.coeffRef(1,0) = -ty + y_t - (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(sin(fi)*sin(om)*cos(ka) + sin(ka)*cos(om)) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(-sin(fi)*sin(ka)*sin(om) + cos(ka)*cos(om)) + (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*sin(om)*cos(fi);
delta.coeffRef(2,0) = -tz + z_t - (plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_a*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_x))*(-sin(fi)*cos(ka)*cos(om) + sin(ka)*sin(om)) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_b*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_y))*(sin(fi)*sin(ka)*cos(om) + sin(om)*cos(ka)) - (plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z) - (ray_length - sqrt(pow(plane_d, 2)*pow(ray_dir_x, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_y, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2) + pow(plane_d, 2)*pow(ray_dir_z, 2)/pow(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z, 2)))*(plane_c*(2*plane_a*ray_dir_x + 2*plane_b*ray_dir_y + 2*plane_c*ray_dir_z) - ray_dir_z))*cos(fi)*cos(om);
}
inline void point_to_point_source_to_target_mirror_tait_bryan_wc_get_intersection(Eigen::Matrix<double, 3, 1> &intersection, double tx, double ty, double tz, double om, double fi, double ka, double ray_dir_x, double ray_dir_y, double ray_dir_z, double ray_length, double plane_a, double plane_b, double plane_c, double plane_d)
{intersection.coeffRef(0,0) = -plane_d*ray_dir_x/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z);
intersection.coeffRef(1,0) = -plane_d*ray_dir_y/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z);
intersection.coeffRef(2,0) = -plane_d*ray_dir_z/(plane_a*ray_dir_x + plane_b*ray_dir_y + plane_c*ray_dir_z);
}
